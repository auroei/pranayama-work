<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pranayama @ work</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: #E5E7EB; /* text-gray-200 */
        }
        /* Custom transition for smooth background color changes */
        .transition-bg {
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        /* Style for the connector pseudo-element */
        #visualizer-panel::before {
            content: '';
            position: absolute;
            background-color: #374151; /* bg-gray-700 */
            transition: top 0.25s ease-out, height 0.25s ease-out, background-color 0.3s ease-in-out;
            z-index: 0; /* Ensure it's behind the button */
        }
        /* Styles for the modal */
        #calendar-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="h-screen flex flex-col p-4 sm:p-6 lg:p-8">

    <!-- Header -->
    <header class="mb-6 flex-shrink-0 flex justify-between items-start">
        <div>
            <h1 class="text-2xl sm:text-3xl text-white">Pranayama @ work</h1>
            <p class="text-gray-400">Breath work to center yourself</p>
        </div>
        <button id="calendar-btn" class="text-right border border-gray-600 hover:border-gray-500 transition-colors text-white font-semibold py-2 px-4 rounded-lg">
            <span>Add to calendar</span>
            <span class="block text-xs text-gray-400 font-normal">without sharing email</span>
        </button>
    </header>

    <!-- Main Content -->
    <main class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-8 lg:gap-12 overflow-hidden">
        
        <!-- Left Column: Exercise Selection -->
        <div class="flex flex-col justify-center overflow-y-auto">
            <div id="exercise-list" class="space-y-3">
                <!-- Exercise items will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Right Column: Visualizer and Controls -->
        <div id="visualizer-panel" class="relative flex flex-col items-center justify-center bg-gray-700 rounded-2xl p-6 h-full transition-bg overflow-hidden">
            <!-- Mute button will be injected here -->
            <div id="visualizer-content" class="text-center w-full max-w-sm h-full">
                <!-- Content will be updated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Footer with Video Links -->
    <footer class="flex-shrink-0 text-center text-xs text-gray-500 mt-6">
        <p>Learn more about the techniques: 
            <a href="https://www.youtube.com/watch?v=zMEFBM0pEQw" target="_blank" rel="noopener noreferrer" class="hover:text-gray-300 transition-colors">Coherent Breathing</a> |
            <a href="https://www.youtube.com/watch?v=oN8xV3Kb5-Q" target="_blank" rel="noopener noreferrer" class="hover:text-gray-300 transition-colors">Box Breathing</a> |
            <a href="https://www.youtube.com/watch?v=p8fjYPC-k2k" target="_blank" rel="noopener noreferrer" class="hover:text-gray-300 transition-colors">4-7-8 Breath</a> |
            <a href="https://www.youtube.com/watch?v=TsYT02UnkMA" target="_blank" rel="noopener noreferrer" class="hover:text-gray-300 transition-colors">Bhastrika</a> |
            <a href="https://www.youtube.com/watch?v=ZEl3FAaSrX4" target="_blank" rel="noopener noreferrer" class="hover:text-gray-300 transition-colors">Cyclic Sighing</a>
        </p>
    </footer>

    <!-- Calendar Modal -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-semibold text-white mb-2">Create a 10 min recurring invite</h3>
            <p class="text-gray-400 mb-6">without sharing your email</p>
            <div class="mb-6">
                <label for="reminder-time" class="block text-sm font-medium text-gray-400 mb-2">Reminder Time</label>
                <input type="time" id="reminder-time" value="10:00" class="bg-gray-700 border border-gray-600 text-white text-center text-lg rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
            </div>
            <p class="text-sm text-gray-400 mb-4">Bro tip: Add your friends in the guest list, üíÅ‚Äç‚ôÇÔ∏è</p>
            <div class="space-y-3">
                <button id="google-cal-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Add to Google Calendar</button>
                <button id="outlook-cal-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Add to Outlook Calendar</button>
                <button id="ics-cal-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Download for Other Apps (.ics)</button>
            </div>
            <button id="close-modal-btn" class="mt-6 text-gray-400 hover:text-white transition-colors">Cancel</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const universalPostureStage = { name: 'Posture Check', duration: 5, pattern: [{ visual: 'Sit Tall', vocal: 'Sit tall with a straight spine and relaxed neck.', duration: 5, method: '' }] };
            
            const exercises = [
                {
                    id: 1,
                    title: 'Start my day',
                    description: `Coherent breathing for balance.`,
                    duration: 365, // 6 minutes + 5s
                    icon: `<span class="text-2xl">‚òÄÔ∏è</span>`,
                    color: '#374151', // bg-gray-700
                    stages: [
                        universalPostureStage,
                        { name: 'Grounding', duration: 60, pattern: [{ visual: 'Breathe Naturally', vocal: 'For the first minute, just breathe naturally.', duration: 60, method: 'Nose' }] },
                        { name: 'Coherent Breathing', duration: 240, pattern: [
                            { visual: 'Inhale', vocal: 'Inhale for 5', duration: 5, method: 'Nose' },
                            { visual: 'Exhale', vocal: 'Exhale for 5', duration: 5, method: 'Nose' },
                        ]},
                        { name: 'Observation', duration: 60, pattern: [{ visual: 'Breathe Naturally', vocal: 'Now, return to your natural breath.', duration: 60, method: 'Nose' }] }
                    ]
                },
                {
                    id: 2,
                    title: 'Recover from meetings',
                    description: `Uses Box Breathing to reset and calm.`,
                    duration: 305, // 5 minutes + 5s
                    icon: `<span class="text-2xl">üòµ‚Äçüí´</span>`,
                    color: '#374151', // bg-gray-700
                    stages: [
                        universalPostureStage,
                        { name: 'Diaphragmatic Awareness', duration: 60, pattern: [{ visual: 'Breathe Deeply', vocal: 'Breathe deeply into your belly.', duration: 60, method: 'Nose' }] },
                        { name: 'Box Breathing', duration: 180, pattern: [
                            { visual: 'Inhale', vocal: 'Inhale for 5', duration: 5, method: 'Nose' },
                            { visual: 'Hold', vocal: 'Hold for 5', duration: 5, method: '' },
                            { visual: 'Exhale', vocal: 'Exhale for 5', duration: 5, method: 'Nose' },
                            { visual: 'Hold', vocal: 'Hold for 5', duration: 5, method: '' },
                        ]},
                        { name: 'Integration', duration: 60, pattern: [{ visual: 'Breathe Gently', vocal: 'Return to your natural breath.', duration: 60, method: 'Nose' }] }
                    ]
                },
                {
                    id: 3,
                    title: 'Enter flow state',
                    description: `Uses 4-7-8 Breath to quiet the mind.`,
                    setupInstruction: 'Rest your tongue behind your top front teeth.',
                    duration: 425, // 7 minutes + 5s
                    icon: `<span class="text-2xl">üéØ</span>`,
                    color: '#374151', // bg-gray-700
                    stages: [
                        universalPostureStage,
                        { name: 'Settling In', duration: 60, pattern: [{ visual: 'Breathe Naturally', vocal: 'Settle in and breathe naturally.', duration: 60, method: 'Nose' }] },
                        { name: '4-7-8 Breathing', duration: 300, pattern: [
                            { visual: 'Inhale', vocal: 'Inhale through your nose for 4', duration: 4, method: 'Nose' },
                            { visual: 'Hold', vocal: 'Hold for 7', duration: 7, method: '' },
                            { visual: 'Exhale', vocal: 'Exhale through your mouth for 8', duration: 8, method: 'Mouth' },
                        ]},
                        { name: 'Silent Focus', duration: 60, pattern: [{ visual: 'Breathe Normally', vocal: 'Now, breathe normally.', duration: 60, method: 'Nose' }] }
                    ]
                },
                {
                    id: 4,
                    title: 'Beat drowsiness',
                    description: `Uses Bhastrika to energize and awaken.`,
                    duration: 305, // 5 minutes + 5s
                    icon: `<span class="text-2xl">‚ö°Ô∏è</span>`,
                    color: '#374151', // bg-gray-700
                     stages: [
                        universalPostureStage,
                        { name: 'Round 1', duration: 60, pattern: Array(20).fill({ visual: 'Breathe Forcefully', vocal: 'Breathe forcefully', duration: 1, method: 'Nose' }).concat([{ visual: 'Deep Inhale', vocal: 'Deep inhale', duration: 2, method: 'Nose' }, { visual: 'Hold', vocal: 'Hold', duration: 18, method: '' }]) },
                        { name: 'Rest', duration: 30, pattern: [{ visual: 'Breathe Normally', vocal: 'Rest.', duration: 30, method: 'Nose' }] },
                        { name: 'Round 2', duration: 60, pattern: Array(20).fill({ visual: 'Breathe Forcefully', vocal: 'Breathe forcefully', duration: 1, method: 'Nose' }).concat([{ visual: 'Deep Inhale', vocal: 'Deep inhale', duration: 2, method: 'Nose' }, { visual: 'Hold', vocal: 'Hold', duration: 18, method: '' }]) },
                        { name: 'Rest', duration: 30, pattern: [{ visual: 'Breathe Normally', vocal: 'Rest.', duration: 30, method: 'Nose' }] },
                        { name: 'Round 3', duration: 60, pattern: Array(20).fill({ visual: 'Breathe Forcefully', vocal: 'Breathe forcefully', duration: 1, method: 'Nose' }).concat([{ visual: 'Deep Inhale', vocal: 'Deep inhale', duration: 2, method: 'Nose' }, { visual: 'Hold', vocal: 'Hold', duration: 18, method: '' }]) },
                        { name: 'Observation', duration: 60, pattern: [{ visual: 'Breathe Naturally', vocal: 'Return to your natural breath.', duration: 60, method: 'Nose' }] }
                    ]
                },
                {
                    id: 5,
                    title: 'Decompress after long day',
                    description: `Uses Cyclic Sighing to release stress.`,
                    duration: 485, // 8 minutes + 5s
                    icon: `<span class="text-2xl">üòå</span>`,
                    color: '#374151', // bg-gray-700
                    stages: [
                        universalPostureStage,
                        { name: 'Cyclic Sighing', duration: 120, pattern: [
                            { visual: 'Inhale', vocal: 'Inhale', duration: 1.5, method: 'Nose' },
                            { visual: 'Inhale Again', vocal: 'And again', duration: 0.5, method: 'Nose' },
                            { visual: 'Long Exhale', vocal: 'Long exhale', duration: 4, method: 'Mouth' },
                        ]},
                        { name: 'Deep Relaxation', duration: 300, pattern: [
                            { visual: 'Inhale', vocal: 'Inhale for 5', duration: 5, method: 'Nose' },
                            { visual: 'Exhale', vocal: 'Exhale for 10', duration: 10, method: 'Mouth' },
                        ]},
                        { name: 'Restful Awareness', duration: 60, pattern: [{ visual: 'Breathe Naturally', vocal: 'Return to your natural breath.', duration: 60, method: 'Nose' }] }
                    ]
                },
            ];

            // --- STATE ---
            let selectedExerciseId = null; 
            let isSessionActive = false;
            let timerInterval = null;
            let animationTimeout = null;
            let remainingTime = 0;
            let currentStageIndex = 0;
            let currentPatternIndex = 0;
            let isMuted = true;
            let lastSpokenInstruction = '';

            // --- DOM ELEMENTS ---
            const exerciseListEl = document.getElementById('exercise-list');
            const visualizerPanelEl = document.getElementById('visualizer-panel');
            const visualizerContentEl = document.getElementById('visualizer-content');
            const calendarBtn = document.getElementById('calendar-btn');
            const calendarModal = document.getElementById('calendar-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const googleCalBtn = document.getElementById('google-cal-btn');
            const outlookCalBtn = document.getElementById('outlook-cal-btn');
            const icsCalBtn = document.getElementById('ics-cal-btn');
            const reminderTimeInput = document.getElementById('reminder-time');
            
            // --- ICONS ---
            const speakerOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-300"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;
            const speakerOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`;
            
            // --- RENDER FUNCTIONS ---
            function renderExerciseList() {
                exerciseListEl.innerHTML = '';
                exercises.forEach(exercise => {
                    const isSelected = exercise.id === selectedExerciseId;
                    const itemEl = document.createElement('div');
                    itemEl.className = `transition-bg flex items-center p-4 rounded-2xl cursor-pointer border-2 ${isSelected ? 'bg-gray-700 border-blue-500 selected-item relative z-10' : 'bg-gray-800 border-transparent hover:border-gray-600'}`;
                    itemEl.dataset.id = exercise.id;
                    
                    itemEl.innerHTML = `
                        <div class="mr-4 w-12 flex-shrink-0 flex flex-col items-center">
                            <div class="text-4xl font-bold text-white">${Math.round(exercise.duration / 60)}</div>
                            <div class="text-sm text-gray-400">mins</div>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-white">${exercise.title}</h3>
                            <p class="text-sm text-gray-400 exercise-description">${exercise.description}</p>
                        </div>
                        <div class="ml-4">${exercise.icon}</div>
                    `;
                    itemEl.addEventListener('click', (e) => {
                        handleExerciseSelect(exercise.id)
                    });
                    exerciseListEl.appendChild(itemEl);
                });
                updateConnector();
            }

            function renderVisualizerPanel() {
                const exercise = exercises.find(ex => ex.id === selectedExerciseId);
                
                if (!exercise) {
                    renderWelcomeState();
                    return;
                }

                remainingTime = exercise.duration;
                const initialInstruction = exercise.setupInstruction || 'Ready to begin?';

                visualizerContentEl.innerHTML = `
                    <div class="flex flex-col h-full justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-1">${exercise.title}</h3>
                            <p id="stage-name" class="text-gray-400 text-sm h-10 flex items-center justify-center">${initialInstruction}</p>
                        </div>
                        
                        <div id="visualizer-circle-container" class="relative w-48 h-48 sm:w-64 sm:h-64 flex items-center justify-center my-4 mx-auto">
                            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-800" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                <circle id="progress-ring" class="text-green-500" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" style="transform: rotate(-90deg); transform-origin: 50% 50%; stroke-dasharray: 283; stroke-dashoffset: 283;" />
                            </svg>
                            <div id="visualizer-circle" class="absolute w-32 h-32 sm:w-48 sm:h-48 rounded-full flex items-center justify-center text-center" style="transition: transform 0.5s ease-in-out; background-image: radial-gradient(circle, rgba(22, 163, 74, 0.5) 0%, rgba(17, 124, 63, 0.5) 100%);">
                                <div>
                                    <div id="instruction-text" class="text-2xl font-bold text-white">Ready</div>
                                    <div id="method-text" class="text-sm text-green-300 opacity-70"></div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div id="timer" class="text-4xl font-bold text-white mb-2">${formatTime(remainingTime)}</div>
                            <p class="text-gray-400 mb-6">Remaining</p>
                            <button id="start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-2xl transition-colors">
                                Start Session
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('start-btn').addEventListener('click', handleStartStop);
            }
            
            function renderWelcomeState() {
                visualizerContentEl.innerHTML = `
                    <div class="flex flex-col h-full items-center justify-center">
                        <div class="text-center">
                            <h3 class="text-xl font-semibold text-white mb-2">Welcome</h3>
                            <p class="text-gray-400">Please select an exercise to begin.</p>
                        </div>
                    </div>
                `;
            }

            function setupMuteButton() {
                let muteBtn = document.getElementById('mute-btn');
                if (!muteBtn) {
                    muteBtn = document.createElement('button');
                    muteBtn.id = 'mute-btn';
                    muteBtn.className = 'absolute top-4 right-4 p-2 rounded-full hover:bg-gray-600 transition-colors z-20';
                    visualizerPanelEl.appendChild(muteBtn);
                    muteBtn.addEventListener('click', toggleMute);
                }
                muteBtn.innerHTML = isMuted ? speakerOffIcon : speakerOnIcon;
            }

            // --- HANDLERS & LOGIC ---
            function handleExerciseSelect(id) {
                if (isSessionActive) return;
                selectedExerciseId = id;
                renderExerciseList();
                renderVisualizerPanel();
                setupMuteButton();
            }

            function handleStartStop() {
                if (isSessionActive) stopSession();
                else startSession();
            }

            function startSession() {
                isSessionActive = true;
                currentStageIndex = 0;
                currentPatternIndex = 0;
                lastSpokenInstruction = '';
                const exercise = exercises.find(ex => ex.id === selectedExerciseId);
                remainingTime = exercise.duration;

                const startBtn = document.getElementById('start-btn');

                if (startBtn) {
                    startBtn.textContent = 'Stop Session';
                    startBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    startBtn.classList.add('bg-gray-600', 'hover:bg-gray-500'); // Neutral gray color
                }
                
                exerciseListEl.style.pointerEvents = 'none';
                exerciseListEl.style.opacity = '0.5';

                runTimer();
                runAnimationLoop();
            }

            function stopSession() {
                isSessionActive = false;
                clearInterval(timerInterval);
                clearTimeout(animationTimeout);
                window.speechSynthesis.cancel();
                
                exerciseListEl.style.pointerEvents = 'auto';
                exerciseListEl.style.opacity = '1';

                renderVisualizerPanel();
                setupMuteButton();
            }
            
            function updateConnector() {
                const selectedButton = document.querySelector('.selected-item');
                const mainGrid = document.querySelector('main');
                const visualizerPanel = document.getElementById('visualizer-panel');

                if (!selectedButton || !mainGrid || !visualizerPanel) {
                    let styleTag = document.getElementById('dynamic-connector-styles');
                    if (styleTag) styleTag.innerHTML = `#visualizer-panel::before { height: 0px; }`;
                    return;
                };

                const selectedExercise = exercises.find(ex => ex.id === selectedExerciseId);
                visualizerPanel.style.backgroundColor = selectedExercise.color;

                const buttonRect = selectedButton.getBoundingClientRect();
                const mainGridRect = mainGrid.getBoundingClientRect();

                const top = buttonRect.top - mainGridRect.top;
                const height = buttonRect.height;
                
                let styleTag = document.getElementById('dynamic-connector-styles');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'dynamic-connector-styles';
                    document.head.appendChild(styleTag);
                }
                
                const gap = window.innerWidth >= 768 ? (window.innerWidth >= 1024 ? 48 : 32) : 32; // gap in pixels

                styleTag.innerHTML = `
                    #visualizer-panel::before {
                        top: ${top}px;
                        height: ${height}px;
                        left: -${gap}px;
                        width: ${gap}px;
                        background-color: ${selectedExercise.color};
                    }
                `;
            }

            function runTimer() {
                const exercise = exercises.find(ex => ex.id === selectedExerciseId);
                const totalDuration = exercise.duration;
                const progressRing = document.getElementById('progress-ring');
                const circumference = 2 * Math.PI * 45;

                timerInterval = setInterval(() => {
                    remainingTime--;
                    document.getElementById('timer').textContent = formatTime(remainingTime);
                    
                    const progress = (totalDuration - remainingTime) / totalDuration;
                    const offset = circumference * (1 - progress);
                    if(progressRing) progressRing.style.strokeDashoffset = offset;

                    if (remainingTime <= 0) {
                        stopSession();
                        const instructionText = document.getElementById('instruction-text');
                        if(instructionText) instructionText.textContent = 'Complete!';
                        const stageNameEl = document.getElementById('stage-name');
                        if(stageNameEl) stageNameEl.textContent = "Session finished.";
                    }
                }, 1000);
            }

            function runAnimationLoop() {
                if (!isSessionActive) return;

                const exercise = exercises.find(ex => ex.id === selectedExerciseId);
                const stage = exercise.stages[currentStageIndex];
                
                if (!stage) {
                    stopSession();
                    return;
                }
                
                const stageEndTime = exercise.stages.slice(0, currentStageIndex + 1).reduce((acc, s) => acc + s.duration, 0);
                const timeUntilNextStage = stageEndTime - (exercise.duration - remainingTime);
                
                if (timeUntilNextStage <= 3 && exercise.stages[currentStageIndex + 1]) {
                    clearTimeout(animationTimeout);
                    const visualizerCircle = document.getElementById('visualizer-circle');
                    const instructionText = document.getElementById('instruction-text');
                    const methodText = document.getElementById('method-text');
                    
                    if (visualizerCircle) visualizerCircle.style.transform = 'scale(0.85)';
                    if (instructionText) instructionText.textContent = `Prepare for...`;
                    const nextStageName = exercise.stages[currentStageIndex + 1].name;
                    if (methodText) methodText.textContent = nextStageName;
                    speak(`Prepare for ${nextStageName}`);

                    animationTimeout = setTimeout(() => {
                        currentStageIndex++;
                        currentPatternIndex = 0;
                        lastSpokenInstruction = '';
                        runAnimationLoop();
                    }, 3000);
                    return;
                }

                const stageNameEl = document.getElementById('stage-name');
                const visualizerCircle = document.getElementById('visualizer-circle');
                const instructionText = document.getElementById('instruction-text');
                const methodText = document.getElementById('method-text');
                
                if (!visualizerCircle || !instructionText || !methodText || !stageNameEl) return;

                const step = stage.pattern[currentPatternIndex % stage.pattern.length];
                
                if (stage.name === 'Posture Check') {
                    stageNameEl.textContent = step.visual;
                    instructionText.textContent = 'Ready';
                    methodText.textContent = '';
                } else {
                    stageNameEl.textContent = stage.name;
                    instructionText.textContent = step.visual;
                    methodText.textContent = step.method;
                }
                
                if (!isMuted && step.vocal !== lastSpokenInstruction) {
                    speak(step.vocal);
                    lastSpokenInstruction = step.vocal;
                }
                
                visualizerCircle.style.transitionDuration = `${step.duration}s`;
                visualizerCircle.style.transitionTimingFunction = 'cubic-bezier(0.45, 0, 0.55, 1)';

                const instructionLower = step.visual.toLowerCase();
                if (instructionLower.includes('inhale')) {
                    visualizerCircle.style.transform = 'scale(1)';
                } else if (instructionLower.includes('exhale')) {
                    visualizerCircle.style.transform = 'scale(0.7)';
                } else if (instructionLower.includes('breathe') || instructionLower.includes('rest') || instructionLower.includes('sit')) {
                    visualizerCircle.style.transitionTimingFunction = 'linear';
                    visualizerCircle.style.transform = 'scale(0.85)';
                }

                animationTimeout = setTimeout(() => {
                    currentPatternIndex++;
                    runAnimationLoop();
                }, step.duration * 1000);
            }
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            function speak(text) {
                if (isMuted || !('speechSynthesis' in window)) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }

            function toggleMute() {
                isMuted = !isMuted;
                const muteBtn = document.getElementById('mute-btn');
                if (muteBtn) muteBtn.innerHTML = isMuted ? speakerOffIcon : speakerOnIcon;
                if (isMuted) {
                    window.speechSynthesis.cancel();
                }
            }

            // --- Calendar Modal Logic ---
            function showModal() {
                calendarModal.classList.remove('opacity-0', 'pointer-events-none');
            }

            function hideModal() {
                calendarModal.classList.add('opacity-0', 'pointer-events-none');
            }

            function getEventDetails() {
                const time = reminderTimeInput.value;
                const [hours, minutes] = time.split(':');
                
                const now = new Date();
                const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                const endDate = new Date(startDate.getTime() + 10 * 60000); // 10 minutes duration

                const toUTC = (date) => date.toISOString().replace(/-|:|\.\d+/g, '');

                return {
                    title: 'Breath work üßò',
                    description: 'Center yourself at pranayama.work',
                    location: 'www.pranayama.work',
                    startDate,
                    endDate,
                    toUTC
                };
            }

            function generateGoogleCalendarLink() {
                const details = getEventDetails();
                const gCalUrl = new URL('https://www.google.com/calendar/render');
                gCalUrl.searchParams.append('action', 'TEMPLATE');
                gCalUrl.searchParams.append('text', details.title);
                gCalUrl.searchParams.append('dates', `${details.toUTC(details.startDate)}/${details.toUTC(details.endDate)}`);
                gCalUrl.searchParams.append('details', details.description);
                gCalUrl.searchParams.append('location', details.location);
                gCalUrl.searchParams.append('recur', 'RRULE:FREQ=DAILY');
                window.open(gCalUrl.toString(), '_blank');
                hideModal();
            }

            function generateOutlookCalendarLink() {
                 const details = getEventDetails();
                const outlookUrl = new URL('https://outlook.live.com/calendar/0/deeplink/compose');
                outlookUrl.searchParams.append('path', '/calendar/action/compose');
                outlookUrl.searchParams.append('rru', 'addevent');
                outlookUrl.searchParams.append('subject', details.title);
                outlookUrl.searchParams.append('startdt', details.startDate.toISOString());
                outlookUrl.searchParams.append('enddt', details.endDate.toISOString());
                outlookUrl.searchParams.append('body', details.description);
                outlookUrl.searchParams.append('location', details.location);
                window.open(outlookUrl.toString(), '_blank');
                hideModal();
            }

            function generateIcsFile() {
                const details = getEventDetails();
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'BEGIN:VEVENT',
                    `DTSTART:${details.toUTC(details.startDate)}`,
                    `DTEND:${details.toUTC(details.endDate)}`,
                    'RRULE:FREQ=DAILY',
                    'SUMMARY:' + details.title,
                    'DESCRIPTION:' + details.description,
                    'LOCATION:' + details.location,
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\n');

                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'pranayama-reminder.ics';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                hideModal();
            }

            // --- INITIALIZATION ---
            function init() {
                renderExerciseList();
                renderVisualizerPanel();
                setupMuteButton();
                window.addEventListener('resize', updateConnector);
                
                calendarBtn.addEventListener('click', showModal);
                closeModalBtn.addEventListener('click', hideModal);
                calendarModal.addEventListener('click', (e) => {
                    if (e.target === calendarModal) {
                        hideModal();
                    }
                });
                googleCalBtn.addEventListener('click', generateGoogleCalendarLink);
                outlookCalBtn.addEventListener('click', generateOutlookCalendarLink);
                icsCalBtn.addEventListener('click', generateIcsFile);
            }

            init();
        });
    </script>
</body>
</html>

